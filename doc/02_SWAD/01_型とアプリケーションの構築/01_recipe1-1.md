# Recipe1-1

## オブジェクト終了期間の管理
### 課題
大量のリソースを使用することによってアプリケーションが異常終了してしまう
Source: VieModel/Recipe1/BadDeploymentProcess

- SrreamWriter reportが問題
- ファイルを参照し続けるため、常にリソースを解放する必要がある
- 使用後にリソースを解放しなかった場合、全てのアプリケーションがファイルにアクセスできなくなる
- あらゆる操作がエラーとなり、その原因も特定しづらい

### 解決策
Source: ViewModel/Recipe1/GoodDeploymentProcess

- 破棄パターンを実装してリソースを解放する
  - インターフェースIDisposableを継承し、リソース解放メソッドやファイナライザを実装する
  - disposedフィールドは現在のオブジェクトが1度しか破棄されないようにするために定義
- IDesposableの継承がなくてもオブジェクト廃棄時にファイナライザが呼び出される
  - インスタンス化されたマネージドオブジェクトは、解放されるタイミングを開発者が管理できない
  - 破棄中のオブジェクトがGCで破棄済みとなるリスクがある（ObjectDisposedException）
- ファイナライザを実装していれば、ハンドルなどにより解放できなかったリソースの解放漏れが防げる
- mainメソッドでusingを用いることによって、処理が終了するまでメモリを確保する
  - ブロックの処理が終了すると、オブジェクトのDispose()が呼び出される

### 注意点
- マネージドリソースでは、ファイナライザを実装してはいけない
  - GCがファイナライザを認識し、破棄処理中にファイナライザを呼び出してしまう（オーバヘッドのリスク）
- 基本的なアプリケーションではアンマネージドリソースのオブジェクトは保持しないので、実装ケースの注意が必要
  - マネージドリソース：C#や.NET Frameworkのオブジェクト
  - アンマネージリソース：ファイルハンドル、APIからのメモリ確保、データベース接続など
- Dispose()メソッド内では、GC.SuppressFinalizeが必要
  - このメソッドによって、GCに全てのリソースの解放を通知できる
  - GCも対象のオブジェクトに対してファイナライザを呼び出すことがなくなる

### 考えられる他のケース
- アンマネージドリソースで、操作が必要なケース
  - エクセルなどでハンドルを独占するアプリケーション
- 任意のタイミングでリソースを解放したいケース
  - GCによる解放の前で使用する

